#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
. "$SCRIPT_DIR/../lib/common.sh"

require_cmd fail2ban-client

usage() {
  cat <<EOF
Usage:
  $(basename "$0") JAIL IP

Example:
  $(basename "$0") sshd 1.2.3.4
EOF
  exit 1
}

[[ $# -eq 2 ]] || usage

JAIL="$1"
IP="$2"

if ! [[ "$IP" =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]]; then
  die "Invalid IP address: $IP"
fi

_green "Banning $IP in jail '$JAIL'..."
run_f2b set "$JAIL" banip "$IP" || die "Failed to ban IP in $JAIL"
_green "Done."
